{% extends "base.html" %}

{% block title %}{{ module }} - {{ product }} {{ version }} - 产品手册文档查看器{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('browse') }}">浏览</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('browse_product', product=product) }}">{{ product }}</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('browse_version', product=product, version=version) }}">{{ version }}</a></li>
        <li class="breadcrumb-item active">{{ module }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-folder-open"></i>
            {% if module == '根目录' %}
                <span class="text-muted">{{ module }}</span>
            {% else %}
                {{ module }}
            {% endif %}
        </h1>
        <p class="text-muted">
            {{ product }} {{ version }} - 
            {% if module == '根目录' %}
                根目录下的文档
            {% else %}
                {{ module }} 模块
            {% endif %}
            ({{ documents|length }} 个文档)
        </p>
    </div>
</div>

{% if documents %}
<div class="row">
    {% for doc in documents %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">
                    <i class="bi bi-file-earmark-pdf text-danger"></i>
                    <span class="text-truncate" title="{{ doc.name }}">
                        {{ doc.name }}
                    </span>
                </h5>
                <div class="card-text text-muted flex-grow-1">
                    <small>
                        <i class="bi bi-hdd"></i> {{ doc.size_human }}
                    </small>
                </div>
                <div class="mt-auto d-flex gap-2">
                    <a href="/pdf/{{ doc.relative_path }}" 
                       target="_blank" 
                       class="btn btn-primary btn-sm flex-grow-1">
                        <i class="bi bi-eye"></i>
                        在线查看
                    </a>
                    <a href="/download/{{ doc.relative_path }}" 
                       class="btn btn-outline-secondary btn-sm"
                       title="下载文件">
                        <i class="bi bi-download"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 文档列表视图切换 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>文档列表</h3>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="toggleView('grid')">
                    <i class="bi bi-grid-3x3-gap"></i> 网格
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleView('list')">
                    <i class="bi bi-list"></i> 列表
                </button>
            </div>
        </div>
        
        <div id="listView" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>文档名称</th>
                            <th>文件大小</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td>
                                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                {{ doc.name }}
                            </td>
                            <td>{{ doc.size_human }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="/pdf/{{ doc.relative_path }}" 
                                       target="_blank" 
                                       class="btn btn-primary">
                                        <i class="bi bi-eye"></i> 查看
                                    </a>
                                    <a href="/download/{{ doc.relative_path }}" 
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-download"></i> 下载
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-triangle"></i>
            该模块暂无可用文档。
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function toggleView(viewType) {
    const gridView = document.querySelector('.row:has(.card)');
    const listView = document.getElementById('listView');
    const gridBtn = document.querySelector('button[onclick="toggleView(\'grid\')"]');
    const listBtn = document.querySelector('button[onclick="toggleView(\'list\')"]');
    
    if (viewType === 'grid') {
        gridView.style.display = '';
        listView.style.display = 'none';
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
    } else {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        gridBtn.classList.remove('active');
        listBtn.classList.add('active');
    }
}

// 表格排序功能
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index < 2) { // 只对前两列添加排序
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => sortTable(index));
            }
        });
    }
});

function sortTable(columnIndex) {
    const table = document.querySelector('table tbody');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        if (columnIndex === 1) { // 文件大小列
            return compareSizes(aText, bText);
        } else { // 文件名列
            return aText.localeCompare(bText);
        }
    });
    
    // 重新插入排序后的行
    rows.forEach(row => table.appendChild(row));
}

function compareSizes(a, b) {
    const getBytes = (sizeStr) => {
        const match = sizeStr.match(/^(\d+\.?\d*)\s*([KMGT]?B)$/i);
        if (!match) return 0;
        
        const value = parseFloat(match[1]);
        const unit = match[2].toUpperCase();
        
        const multipliers = {
            'B': 1,
            'KB': 1024,
            'MB': 1024 * 1024,
            'GB': 1024 * 1024 * 1024,
            'TB': 1024 * 1024 * 1024 * 1024
        };
        
        return value * (multipliers[unit] || 1);
    };
    
    return getBytes(a) - getBytes(b);
}
</script>
{% endblock %}
